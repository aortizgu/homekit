{{set . "title" "Home"}}
{{template "header.html" .}}


<div id="no-connection" class="container container-body" hidden>
  <div class="my_jumbo jumbotron jumbotron-fluid">
    <h3>
      <center style="color: red;">¡CONEXIÓN PERDIDA!</center>
    </h3>
  </div>
</div>
<div class="my-container">
  <div class="col-xs-12 col-md-12 col-lg-12">
    <div class="row">
      <div class="led led-green" hidden></div>
      <div class="led led-red" hidden></div>
      <h1 class="text-center" id="curr-temp"></h1>
    </div>
  </div>
</div>
<div class="container">

  <div class="row">
    <div style="width:80%;margin: auto;">
      <canvas id="canvas"></canvas>
    </div>
  </div>
</div>

<script>

  function RenderChart() {
    $.getJSON("/dashboard/meassurements", function (meassurements) {
      for (let index = 0; index < meassurements.length; index++) {
        const meassurement = meassurements[index];
        var date = (new Date(meassurement["Time"] * 1000)).toLocaleString()
        config.data.labels.push(date);

        config.data.datasets[0].data.push(meassurement["ValCaldera"])
        config.data.datasets[1].data.push(meassurement["ValSensor"])
        if (meassurement["Active"]) {
          config.data.datasets[2].data.push(meassurement["ValCaldera"])
        } else {
          config.data.datasets[2].data.push(0)

        }
        window.myLine.update();
      }
    });
  }

  var config = {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Temperaturas exterior',
        backgroundColor: window.chartColors.green,
        borderColor: window.chartColors.green,
        data: [],
        fill: false,
      }, {
        label: 'Temperaturas salón',
        backgroundColor: window.chartColors.blue,
        borderColor: window.chartColors.blue,
        data: [],
        fill: false,
      }, {
        label: 'Calefación encendida',
        backgroundColor: window.chartColors.red,
        borderColor: window.chartColors.red,
        data: [],
        fill: "origin",
      }]
    },
    options: {
      legend: {
        display: false
      },
      responsive: true,
      title: {
        display: true,
        text: 'Temperaturtas registradas'
      },
      tooltips: {
        mode: 'index',
        intersect: false,
      },
      hover: {
        mode: 'nearest',
        intersect: true
      },
      scales: {
        xAxes: [{
          display: false,
          scaleLabel: {
            display: true,
            labelString: 'Hora'
          }
        }],
        yAxes: [{
          display: true,
          scaleLabel: {
            display: true,
            labelString: 'Grados'
          }
        }]
      }
    }
  };

  window.onload = function () {
    var ctx = document.getElementById('canvas').getContext('2d')
    window.myLine = new Chart(ctx, config)
    WebSocketInit()
    RenderChart()
  };

  function connectionLost() {
    $("#no-connection").show();
  }

  function connectionOK() {
    $("#no-connection").hide();
  }

  function newLiveData(event) {
    var msg = JSON.parse(event.data);
    if (msg != undefined) {
      console.log(msg)
      if (msg["Active"]) {
        $(".led-green").show()
        $(".led-red").hide()
      } else {
        $(".led-green").hide()
        $(".led-red").show()
      }
      $("#curr-temp").html(msg["DeviceTemp"] + "ºC")
    }
  }

  function WebSocketInit() {
    if ("WebSocket" in window) {
      var ws = new WebSocket('ws://' + window.location.host + '/dashboard/live?user={{.user }}');

      ws.onmessage = function (evt) {
        connectionOK();
        newLiveData(evt);
      };

      ws.onclose = function () {
        connectionLost()
        setTimeout(function () { WebSocketInit() }, 5000);
      };

      ws.onopen = function () {
        connectionOK();
      };
    }
    else {
      alert("WebSocket NOT supported by your Browser!");
    }
  }
</script>

{{template "footer.html" .}}